## SSL协议的握手过程

握手阶段：

1. 客户端向服务端发送一串「随机数」。

    具体还有支持的协议版本，比如 TLS 1.0 版；支持的加密方法，比如 RSA 公钥加密；支持的压缩方法。

2. 服务端确认**加密方法**后，给客户端发送一个「数字证书」以及服务器生成的「随机数」
3. 客户端确认**数字证书有效**后，生成一个「随机数」，用数字证书中的「公钥」加密这个随机数后发给服务端。
4. 服务端用自己的「私钥」，用来**解密获取**客户端发送的随机数。
5. 接下来两端根据约定的加密方法，使用前面的**三个**「随机数」，生成「对话密钥」。

最后生成的「对话密钥」将会加密接下来的整个对话过程。

---

## 握手阶段的注意点

有四点需要注意：

1. 生成对话密钥一共需要**三个**「随机数」。

1. 握手之后的对话使用「对话密钥」加密（ 使用的是**对称加密**，用于加快解密的运算速度 ）。服务器的公钥和私钥只用于**加密**和**解密**「对话密钥」（非对称加密），无其他作用，所以服务器的**公钥**和**私钥**只需要用到一次。

1. 服务器**公钥**放在服务器的「数字证书」之中。

1. 整个握手过程都是**明文传输**的，所以整个通话过程的安全，都取决于第三个随机数能不能被破解。

---

## session 的恢复

> 握手阶段是用来建立 SSL 连接。

如果出于某种原因，对话中断，就需要重新握手。

这时有两种方法可以恢复原来的 `session`：一种叫做 **session ID**，另一种叫做**session ticket**。

- **session ID**

    每一次**对话**（ 客户端与客户端的连接 ）都有一个编号（ session ID ）。如果对话中断，下次重连的时候，只要客户端给出这个编号，且服务器有这个编号的记录，双方就可以重新使用**已有**的「对话密钥」，而不必重新生成一把。

    **优点**：所有浏览器都支持。

    **缺点**：**session ID** 往往只保留在一台服务器上。如果客户端的请求发到另一台服务器，就无法恢复对话。

- **session ticket**

    客户端不再发送 **session ID**，而是发送一个服务器在**上一次对话**中发送过来的 **session ticket**。
    
    这个 **session ticket** 是加密的，只有服务器才能解密，其中包括本次对话的主要信息，比如「对话密钥」和「加密方法」。当服务器收到 **session ticket** 以后，解密后就不必重新生成对话密钥了。