### Generator å‡½æ•°çš„å¼‚æ­¥åº”ç”¨

ç”±äº Javascript è¯­è¨€çš„æ‰§è¡Œç¯å¢ƒæ˜¯ã€Œå•çº¿ç¨‹ã€ï¼Œ**å¼‚æ­¥ç¼–ç¨‹**å¯¹ JavaScript è¯­è¨€ç®€ç›´ä¸è¦å¤ªé‡è¦ ğŸ˜Œ å½“ç„¶è¿™ä¹Ÿæ˜¯ JavaScript ä¸­äº˜å¤ä¸å˜çš„è¯é¢˜ã€‚

ä¸ºä»€ä¹ˆè¦æŠŠ JavaScript çš„å¼‚æ­¥åº”ç”¨å’Œ Generator æŒ‚é’©åœ¨ä¸€èµ·å‘¢ï¼Œå› ä¸ºå®ƒï¼ŒJavaScript çš„**å¼‚æ­¥ç¼–ç¨‹**è¿›å…¥ä¸€ä¸ªå…¨æ–°çš„æ—¶ä»£ã€‚

åœ¨ ES6 è¯ç”Ÿä»¥å‰ï¼Œ**å¼‚æ­¥ç¼–ç¨‹**çš„æ–¹æ³•ï¼Œå¤§æ¦‚æœ‰ä¸‹é¢å››ç§ï¼š

- å›è°ƒå‡½æ•°
- äº‹ä»¶ç›‘å¬
- å‘å¸ƒ/è®¢é˜…
- Promise å¯¹è±¡

ã€Œäº‹ä»¶ç›‘å¬ã€å’Œã€Œå‘å¸ƒ/è®¢é˜…ã€æ¯”è¾ƒå¸¸è§ï¼Œç°åœ¨åˆ†åˆ«æ¥è®²è®²è¿™å›è°ƒå‡½æ•°å’Œ Promise çš„å¤§è‡´å†…å®¹ã€‚

#### å›è°ƒå‡½æ•°

> æ‰€è°“å›è°ƒå‡½æ•°ï¼Œå°±æ˜¯æŠŠä»»åŠ¡çš„ç¬¬äºŒæ®µå•ç‹¬å†™åœ¨ä¸€ä¸ªå‡½æ•°é‡Œé¢ï¼Œç­‰åˆ°é‡æ–°æ‰§è¡Œè¿™ä¸ªä»»åŠ¡çš„æ—¶å€™ï¼Œå°±ç›´æ¥è°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚å›è°ƒå‡½æ•°çš„è‹±è¯­åå­— `callback`ï¼Œç›´è¯‘è¿‡æ¥å°±æ˜¯ã€Œé‡æ–°è°ƒç”¨ã€ã€‚

JavaScript è¯­è¨€å¯¹å¼‚æ­¥ç¼–ç¨‹çš„å®ç°ï¼Œå°±æ˜¯å›è°ƒå‡½æ•°ã€‚

ä¸¾ä¸€ä¸ª **Node** ä¸­ã€Œæ–‡ä»¶æ“ä½œã€çš„ä¾‹å­ï¼š

```javascript
fs.readFile('/etc/passwd', 'utf-8', function (err, data) {
  if (err) throw err
  console.log(data)
})
```

ä¸Šé¢ä»£ç ä¸­ï¼Œ`readFile` å‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œå°±æ˜¯ã€Œå›è°ƒå‡½æ•°ã€ï¼Œä¹Ÿå°±æ˜¯ä»»åŠ¡çš„ç¬¬äºŒæ®µã€‚ç­‰åˆ°æ“ä½œç³»ç»Ÿè¿”å›äº† `/etc/passwd` è¿™ä¸ªæ–‡ä»¶ä»¥åï¼Œå›è°ƒå‡½æ•°æ‰ä¼šæ‰§è¡Œã€‚

BTWï¼Œä¸€ä¸ªæœ‰è¶£çš„é—®é¢˜ï¼šä¸ºä»€ä¹ˆ Node çº¦å®šï¼Œå›è°ƒå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå¿…é¡»æ˜¯é”™è¯¯å¯¹è±¡errï¼ˆ å¦‚æœæ²¡æœ‰é”™è¯¯ï¼Œè¯¥å‚æ•°å°±æ˜¯ `null` ï¼‰ï¼Ÿ

> **ç­”**ï¼šNode é‡‡ç”¨ V8 å¼•æ“å¤„ç† JavaScript è„šæœ¬ï¼Œæœ€å¤§ç‰¹ç‚¹å°±æ˜¯å•çº¿ç¨‹è¿è¡Œï¼Œä¸€æ¬¡åªèƒ½è¿è¡Œä¸€ä¸ªä»»åŠ¡ã€‚è¿™å¯¼è‡´ Node å¤§é‡é‡‡ç”¨å¼‚æ­¥æ“ä½œï¼ˆ asynchronous opertion ï¼‰ï¼Œå³ä»»åŠ¡ä¸æ˜¯é©¬ä¸Šæ‰§è¡Œï¼Œè€Œæ˜¯æ’åœ¨ä»»åŠ¡é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œç­‰åˆ°å‰é¢çš„ä»»åŠ¡è¿è¡Œå®Œåå†æ‰§è¡Œã€‚
> 
> ç”±äºè¿™ç§ç‰¹æ€§ï¼ŒæŸä¸€ä¸ªä»»åŠ¡çš„åç»­æ“ä½œï¼Œå¾€å¾€é‡‡ç”¨å›è°ƒå‡½æ•°ï¼ˆ callback ï¼‰çš„å½¢å¼è¿›è¡Œå®šä¹‰ã€‚æ‰€ä»¥ä¸é€‚ç”¨äº `try catch` æ•è·é”™è¯¯ï¼Œçº¦å®šå›è°ƒå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºä¸º `error` å¯¹è±¡ã€‚
> 
> ä¹Ÿå°±æ˜¯è¯´ï¼Œæ‰§è¡Œåˆ†æˆä¸¤æ®µï¼Œç¬¬ä¸€æ®µæ‰§è¡Œå®Œä»¥åï¼Œä»»åŠ¡æ‰€åœ¨çš„ä¸Šä¸‹æ–‡ç¯å¢ƒå°±å·²ç»ç»“æŸäº†ã€‚åœ¨è¿™ä»¥åæŠ›å‡ºçš„é”™è¯¯ï¼ŒåŸæ¥çš„ä¸Šä¸‹æ–‡ç¯å¢ƒå·²ç»æ— æ³•æ•æ‰ï¼Œåªèƒ½å½“ä½œå‚æ•°ï¼Œä¼ å…¥ç¬¬äºŒæ®µã€‚

#### Promise å¯¹è±¡

æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œå›è°ƒå‡½æ•°çš„é—®é¢˜å‡ºç°åœ¨å¤šä¸ªå›è°ƒå‡½æ•°åµŒå¥—ã€‚å‡å®šè¯»å–Aæ–‡ä»¶ä¹‹åï¼Œå†è¯»å–Bæ–‡ä»¶ï¼Œä»£ç å¦‚ä¸‹ï¼š

```javascript
fs.readFile(fileA, 'utf-8', function (err, data) {
  fs.readFile(fileB, 'utf-8', function (err, data) {
    // ...
  })
})
```

è¿™ç§å¤šé‡åµŒå¥—ä½¿å¾—ä»£ç **æ¨ªå‘å‘å±•**ï¼Œå¤šä¸ªå¼‚æ­¥æ“ä½œå½¢æˆäº†å¼ºè€¦åˆã€‚

Promise å¯¹è±¡å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜è€Œæå‡ºçš„ã€‚

å®ƒä¸æ˜¯æ–°çš„è¯­æ³•åŠŸèƒ½ï¼Œè€Œæ˜¯ä¸€ç§æ–°çš„å†™æ³•ï¼Œå…è®¸å°†å›è°ƒå‡½æ•°çš„åµŒå¥—ï¼Œæ”¹æˆã€Œé“¾å¼è°ƒç”¨ã€ï¼š

```javascript
var readFile = require('fs-readfile-promise')

readFile(fileA)
.then(function (data) {
  console.log(data.toString())
})
.then(function () {
  return readFile(fileB)
})
.then(function (data) {
  console.log(data.toString())
})
.catch(function (err) {
  console.log(err)
})
```

å¯ä»¥çœ‹åˆ°ï¼ŒPromise çš„å†™æ³•åªæ˜¯å›è°ƒå‡½æ•°çš„æ”¹è¿›ï¼Œä½¿ç”¨ `then` æ–¹æ³•ä»¥åï¼Œå¼‚æ­¥ä»»åŠ¡çš„ä¸¤æ®µæ‰§è¡Œçœ‹å¾—æ›´æ¸…æ¥šäº†ï¼Œé™¤æ­¤ä»¥å¤–ï¼Œå¹¶æ— æ–°æ„ã€‚

Promise çš„æœ€å¤§é—®é¢˜æ˜¯ä»£ç å†—ä½™ï¼ŒåŸæ¥çš„ä»»åŠ¡è¢« Promise åŒ…è£…äº†ä¸€ä¸‹ï¼Œä¸ç®¡ä»€ä¹ˆæ“ä½œï¼Œä¸€çœ¼çœ‹å»éƒ½æ˜¯ä¸€å † `then`ï¼ŒåŸæ¥çš„è¯­ä¹‰å˜å¾—å¾ˆä¸æ¸…æ¥šã€‚

é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰æ›´å¥½çš„å†™æ³•å‘¢ï¼Ÿ

---

### Generator å‡½æ•°

#### åç¨‹

> ä¼ ç»Ÿçš„ç¼–ç¨‹è¯­è¨€ï¼Œæ—©æœ‰å¼‚æ­¥ç¼–ç¨‹çš„è§£å†³æ–¹æ¡ˆï¼ˆ å…¶å®æ˜¯å¤šä»»åŠ¡çš„è§£å†³æ–¹æ¡ˆ ï¼‰ã€‚å…¶ä¸­æœ‰ä¸€ç§å«åšã€Œåç¨‹ã€ï¼ˆ coroutine ï¼‰ï¼Œæ„æ€æ˜¯å¤šä¸ªçº¿ç¨‹äº’ç›¸åä½œï¼Œå®Œæˆå¼‚æ­¥ä»»åŠ¡ã€‚

åç¨‹æœ‰ç‚¹åƒå‡½æ•°ï¼Œåˆæœ‰ç‚¹åƒçº¿ç¨‹ã€‚å®ƒçš„è¿è¡Œæµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š

- ç¬¬ä¸€æ­¥ï¼Œåç¨‹ `A` å¼€å§‹æ‰§è¡Œã€‚
- ç¬¬äºŒæ­¥ï¼Œåç¨‹ `A` æ‰§è¡Œåˆ°ä¸€åŠï¼Œè¿›å…¥æš‚åœï¼Œæ‰§è¡Œæƒè½¬ç§»åˆ°åç¨‹ `B` ã€‚
- ç¬¬ä¸‰æ­¥ï¼Œï¼ˆä¸€æ®µæ—¶é—´åï¼‰åç¨‹ `B` äº¤è¿˜æ‰§è¡Œæƒã€‚
- ç¬¬å››æ­¥ï¼Œåç¨‹ `A` æ¢å¤æ‰§è¡Œã€‚

Generator å°±æ˜¯ã€Œåç¨‹ã€åœ¨ ES6 ä¸­çš„å®ç°ï¼Œæ¥ä¸‹æ¥ä¸¾ä¸ªæ —å­ ğŸŒ°

```javascript
// å°è£…ä¸€ä¸ªå¼‚æ­¥æ“ä½œ
var fetch = require('node-fetch')

function* gen(){
  var url = 'https://api.github.com/users/github'
  var result = yield fetch(url)
  console.log(result.bio)
}

// æ‰§è¡Œæ“ä½œ
var g = gen()
var result = g.next()

result.value.then(function(data){
  return data.json()
}).then(function(data){
  g.next(data)
})
```

å†…å®¹éƒ½æŒºç®€å•çš„ï¼Œæˆ‘å°±ä¸ä¸€æ­¥æ­¥æè¿°äº†ã€‚å¯ä»¥çœ‹åˆ°ï¼Œè™½ç„¶ Generator å‡½æ•°å°†å¼‚æ­¥æ“ä½œè¡¨ç¤ºå¾—å¾ˆç®€æ´ï¼Œä½†æ˜¯æµç¨‹ç®¡ç†å´ä¸æ–¹ä¾¿ï¼ˆ å³ä½•æ—¶æ‰§è¡Œç¬¬ä¸€é˜¶æ®µã€ä½•æ—¶æ‰§è¡Œç¬¬äºŒé˜¶æ®µ ï¼‰ã€‚

---

### Thunk å‡½æ•°

> è‡ªåŠ¨æ‰§è¡Œ Generator å‡½æ•°çš„ä¸€ç§æ–¹æ³•ã€‚

æ‰€è°“ã€Œä¼ åè°ƒç”¨ã€ï¼Œå³ç›´æ¥å°†å‡½æ•°å‚æ•°ä¸­çš„è¡¨è¾¾å¼ä¼ å…¥å‡½æ•°ä½“ï¼Œåªåœ¨ç”¨åˆ°å®ƒçš„æ—¶å€™æ±‚å€¼ã€‚é¿å…äº†åœ¨è¡¨è¾¾å¼ä¸­è¿›è¡Œäº†æ— ç”¨çš„è®¡ç®—é™ä½æ€§èƒ½ã€‚

ç¼–è¯‘å™¨çš„**ä¼ åè°ƒç”¨**å®ç°ï¼Œå¾€å¾€æ˜¯å°†å‚æ•°æ”¾åˆ°ä¸€ä¸ªã€Œä¸´æ—¶å‡½æ•°ã€ä¹‹ä¸­ï¼Œå†å°†è¿™ä¸ªä¸´æ—¶å‡½æ•°ä¼ å…¥å‡½æ•°ä½“ã€‚è¿™ä¸ªä¸´æ—¶å‡½æ•°å°±å«åš Thunk å‡½æ•°ã€‚

æˆ‘ä»¬æ¥çœ‹çœ‹ JavaScript ä¸­çš„ Thunk å‡½æ•°ï¼š

```javascript
// æ­£å¸¸ç‰ˆæœ¬çš„readFileï¼ˆå¤šå‚æ•°ç‰ˆæœ¬ï¼‰
fs.readFile(fileName, callback)

// Thunkç‰ˆæœ¬çš„readFileï¼ˆå•å‚æ•°ç‰ˆæœ¬ï¼‰
var Thunk = function (fileName) {
  return function (callback) {
    return fs.readFile(fileName, callback)
  }
}

var readFileThunk = Thunk(fileName)
readFileThunk(callback)
```

ä¸Šé¢çš„ `Thunk` å°±æ˜¯ä¸€ä¸ª**ä¸´æ—¶å‡½æ•°**ï¼Œç„¶åé€šè¿‡ä¸´æ—¶å‡½æ•°çš„å‚æ•°ä¼ å…¥å‡½æ•°ä½“ã€‚

---

### Generator å‡½æ•°çš„æµç¨‹ç®¡ç†

å‰é¢è¯´åˆ° Thunk å‡½æ•°ï¼Œä¸è¿‡ Thunk å‡½æ•°å¯¹å¼‚æ­¥ç¼–ç¨‹æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿ

ä»¥å‰ç¡®å®æ²¡ä»€ä¹ˆç”¨ï¼Œä½†æ˜¯ ES6 æœ‰äº† Generator å‡½æ•°ï¼ŒThunk å‡½æ•°ç°åœ¨å¯ä»¥ç”¨äº Generator å‡½æ•°çš„ã€Œè‡ªåŠ¨æµç¨‹ç®¡ç†ã€ã€‚

å…ˆè¯´ Generatorï¼Œå®ƒå¯ä»¥å®Œæˆè‡ªåŠ¨æ‰§è¡Œï¼š

```javascript
function* gen() {
  // ...
}

var g = gen()
var res = g.next()

while(!res.done){
  console.log(res.value)
  res = g.next()
}
```

ä½†æ˜¯é€šè¿‡ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºæ¥ï¼ŒGenerator å¯ä»¥å®Œæˆè‡ªåŠ¨æ‰§è¡Œæ‰€æœ‰ä»»åŠ¡ï¼Œä½†æ˜¯å¹¶ä¸æ»¡è¶³**æ‰§è¡Œå®Œä¸Šä¸€æ­¥åå†æ‰§è¡Œä¸‹ä¸€æ­¥**ï¼Œä¸é€‚åˆå¼‚æ­¥æ“ä½œã€‚

### Thunk å‡½æ•°çš„è‡ªåŠ¨æµç¨‹ç®¡ç†

æ‰€ä»¥è¿™æ—¶å€™ Thunk å‡½æ•°å°±æ´¾ä¸Šç”¨åœºäº†ã€‚ç”±äº Thunk å‡½æ•°å¯ä»¥åœ¨å›è°ƒå‡½æ•°é‡Œï¼Œå°†æ‰§è¡Œæƒäº¤è¿˜ç»™ Generator å‡½æ•°ã€‚Thunk å‡½æ•°çœŸæ­£çš„å¨åŠ›ï¼Œåœ¨äºå¯ä»¥è‡ªåŠ¨æ‰§è¡Œ Generator å‡½æ•°ã€‚ä¸‹é¢å°±æ˜¯ä¸€ä¸ªåŸºäº Thunk å‡½æ•°çš„ Generator æ‰§è¡Œå™¨ã€‚

```javascript
function run(fn) {
  var gen = fn()

  function next(err, data) {
    var result = gen.next(data)
    if (result.done) return
    result.value(next)
  }

  next()
}

function* g() {
  // ...
}

run(g)
```

ä¸Šé¢ä»£ç çš„ `run` å‡½æ•°ï¼Œå°±æ˜¯ä¸€ä¸ª Generator å‡½æ•°çš„è‡ªåŠ¨æ‰§è¡Œå™¨ã€‚

å†…éƒ¨çš„ `next` å‡½æ•°å°±æ˜¯ Thunk çš„**å›è°ƒå‡½æ•°**ã€‚

`next` å‡½æ•°å…ˆå°†æŒ‡é’ˆç§»åˆ° Generator å‡½æ•°çš„ä¸‹ä¸€æ­¥ï¼ˆ `gen.next` æ–¹æ³• ï¼‰ï¼Œç„¶ååˆ¤æ–­ Generator å‡½æ•°æ˜¯å¦ç»“æŸï¼ˆ `result.done` å±æ€§ ï¼‰ï¼Œå¦‚æœæ²¡ç»“æŸï¼Œå°±å°† `next` å‡½æ•°å†ä¼ å…¥ Thunk å‡½æ•°ï¼ˆ `result.value` å±æ€§ ï¼‰ï¼Œå¦åˆ™å°±ç›´æ¥é€€å‡ºã€‚

å½“ç„¶ï¼Œå‰ææ˜¯æ¯ä¸€ä¸ª**å¼‚æ­¥æ“ä½œ**ï¼Œéƒ½è¦æ˜¯ Thunk å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè·Ÿåœ¨ `yield` å‘½ä»¤åé¢çš„å¿…é¡»æ˜¯ Thunk å‡½æ•°ï¼Œæ‰èƒ½åœ¨ä¸Šé¢æŠŠ `next` ä¼ å…¥åˆ°è¿”å›çš„ä¿¡æ¯æ•°ç»„ `value` ä¸­ã€‚

### co æ¨¡å—

å½“ç„¶ï¼Œtjå¤§ç¥æ—©å°±åœ¨ 2013 å¹´å°±å†™äº†ä¸€ä¸ªå°å·¥å…· â€”â€” ã€Œ[co](https://github.com/tj/co)ã€ï¼Œç”¨äº Generator å‡½æ•°çš„è‡ªåŠ¨æ‰§è¡Œã€‚

ç”¨ **co** å†™ä¸€ä¸ªå°ä¾‹å­ï¼Œç”¨äºä¾æ¬¡è¯»å–ä¸¤ä¸ªæ–‡ä»¶ï¼š

```javascript
var gen = function* () {
  var f1 = yield readFile('/etc/fstab')
  var f2 = yield readFile('/etc/shells')
  console.log(f1.toString())
  console.log(f2.toString())
}
```

**co** æ¨¡å—å¯ä»¥è®©æˆ‘ä»¬ä¸ç”¨ç¼–å†™ Generator å‡½æ•°çš„æ‰§è¡Œå™¨ï¼Œåªè¦å°† Generator å‡½æ•°åªè¦ä¼ å…¥coå‡½æ•°ï¼Œå°±ä¼šè‡ªåŠ¨æ‰§è¡Œï¼š

```javascript
var co = require('co')
co(gen)
```

æ­¤å¤–ï¼Œ**co** å‡½æ•°è¿”å›ä¸€ä¸ª **Promise** å¯¹è±¡ï¼Œå› æ­¤å¯ä»¥ç”¨ `then` æ–¹æ³•æ·»åŠ å›è°ƒå‡½æ•°ã€‚

```javascript
co(gen).then(function (){
  console.log('Generator å‡½æ•°æ‰§è¡Œå®Œæˆ')
})
```

ä¸Šé¢ä»£ç ä¸­ï¼Œç­‰åˆ° Generator å‡½æ•°æ‰§è¡Œç»“æŸï¼Œå°±ä¼šè¾“å‡ºä¸€è¡Œæç¤ºã€‚