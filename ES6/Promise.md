ä¸€äº›åŸºç¡€çš„å†…å®¹å·²ç»è®°å½•åœ¨ [ä¸“é¢˜ / Promiseå¯¹è±¡](https://github.com/LBinin/LearnJS/blob/master/%E4%B8%93%E9%A2%98/Promise%E5%AF%B9%E8%B1%A1.md) ç¬”è®°ä¸­ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†ã€‚

---

### æ³¨æ„ç‚¹

1. `resolve` å‡½æ•°çš„å‚æ•°é™¤äº†æ­£å¸¸çš„å€¼ä»¥å¤–ï¼Œè¿˜å¯èƒ½æ˜¯å¦ä¸€ä¸ª **Promise** å®ä¾‹ï¼Œæ¯”å¦‚åƒä¸‹é¢è¿™æ ·ï¼š

    ```javascript
    const p1 = new Promise(function (resolve, reject) {
      // ...
    })

    const p2 = new Promise(function (resolve, reject) {
      // ...
      resolve(p1)
    })
    ```

    ä¸Šé¢ä»£ç ä¸­ï¼Œ`p1` å’Œ `p2` éƒ½æ˜¯ **Promise** çš„å®ä¾‹ï¼Œä½†æ˜¯ `p2` çš„ `resolve` æ–¹æ³•å°† `p1` ä½œä¸ºå‚æ•°ï¼Œå³ä¸€ä¸ªå¼‚æ­¥æ“ä½œçš„ç»“æœæ˜¯è¿”å›**å¦ä¸€ä¸ªå¼‚æ­¥æ“ä½œ**ã€‚

    è¿™æ ·å°±å¯¼è‡´äº†ï¼šè¿™æ—¶ `p1` çš„çŠ¶æ€å°±ä¼šä¼ é€’ç»™ `p2`ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™æ—¶å€™ `p1` çš„çŠ¶æ€å†³å®šäº† `p2` çš„çŠ¶æ€ï¼Œ `p2` çš„çŠ¶æ€å¤±æ•ˆäº†ã€‚

    å¦‚æœ `p1` çš„çŠ¶æ€æ˜¯ `pending`ï¼Œé‚£ä¹ˆ `p2` çš„å›è°ƒå‡½æ•°å°±ä¼šç­‰å¾… `p1` çš„çŠ¶æ€æ”¹å˜ï¼›å¦‚æœ `p1` çš„çŠ¶æ€å·²ç»æ˜¯ `resolved` æˆ–è€… `rejected`ï¼Œé‚£ä¹ˆ `p2` çš„å›è°ƒå‡½æ•°ï¼ˆ `then` ä¸­çš„æ–¹æ³• ï¼‰å°†ä¼šç«‹åˆ»æ‰§è¡Œã€‚

    ä¸¾ä¸ªæ —å­ ğŸŒ°

    ```javascript
    const p1 = new Promise(function (resolve, reject) {
      setTimeout(() => reject(new Error('fail')), 3000)
    })

    const p2 = new Promise(function (resolve, reject) {
      setTimeout(() => resolve(p1), 1000)
    })

    p2
      .then(result => console.log(result))
      .catch(error => console.log(error))
    // Error: fail
    ```

    ä¸Šé¢ä»£ç ä¸­ï¼Œ`p1` æ˜¯ä¸€ä¸ª **Promise**ï¼Œ3 ç§’ä¹‹åå˜ä¸º `rejected`ã€‚`p2` çš„çŠ¶æ€åœ¨ 1 ç§’ä¹‹åæ”¹å˜ï¼Œ`resolve` æ–¹æ³•è¿”å›çš„æ˜¯ `p1`ã€‚è¿™æ—¶å€™ï¼Œç”±äº `p2` è¿”å›çš„æ˜¯å¦ä¸€ä¸ª **Promise**ï¼Œå¯¼è‡´ `p2` è‡ªå·±çš„çŠ¶æ€å¤±æ•ˆï¼Œå¿…é¡»ç”± `p1` çš„çŠ¶æ€æ¥å†³å®šï¼Œè€Œä¸æ˜¯æ­¤æ—¶ `p2` çš„çŠ¶æ€ã€‚æ‰€ä»¥ï¼Œåé¢çš„ `then` è¯­å¥éƒ½å˜æˆé’ˆå¯¹åè€…ï¼ˆ `p1` ï¼‰ã€‚åˆè¿‡äº† 2 ç§’ï¼Œ `p1` å˜ä¸º `rejected`ï¼Œå¯¼è‡´è§¦å‘ `catch` æ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°ã€‚


2. è°ƒç”¨ `resolve` æˆ– `reject` å¹¶ä¸ä¼šç»ˆç»“ **Promise** çš„å‚æ•°ä¸­å‡½æ•°å‰©ä½™éƒ¨åˆ†çš„æ‰§è¡Œï¼š

    ```javascript
    new Promise((resolve, reject) => {
      resolve(1)
      console.log(2)
    }).then(r => {
      console.log(r)
    })
    // 2
    // 1
    ```

    å¯ä»¥çœ‹åˆ°ï¼Œè°ƒç”¨ `resolve(1)` ä»¥åï¼Œåé¢çš„ `console.log(2)` è¿˜æ˜¯ä¼šæ‰§è¡Œï¼Œå¹¶ä¸”ä¼šé¦–å…ˆæ‰“å°å‡ºæ¥ã€‚

    è¿™æ˜¯å› ä¸ºç«‹å³ `resolved` çš„ **Promise** æ˜¯åœ¨æœ¬è½®äº‹ä»¶å¾ªç¯çš„æœ«å°¾æ‰§è¡Œï¼Œæ€»æ˜¯æ™šäºæœ¬è½®å¾ªç¯çš„åŒæ­¥ä»»åŠ¡ã€‚

    ä¸€èˆ¬æ¥è¯´ï¼Œè°ƒç”¨ `resolve` æˆ– `reject` ä»¥åï¼Œ**Promise** çš„ä½¿å‘½å°±å®Œæˆäº†ï¼Œã€Œåç»§æ“ä½œã€åº”è¯¥æ”¾åˆ° `then` æ–¹æ³•é‡Œé¢ï¼Œè€Œä¸åº”è¯¥ç›´æ¥å†™åœ¨ `resolve` æˆ– `reject` çš„åé¢ã€‚æ‰€ä»¥ï¼Œæœ€å¥½åœ¨å®ƒä»¬å‰é¢åŠ ä¸Š **return** è¯­å¥ï¼Œè¿™æ ·å°±ä¸ä¼šæœ‰æ„å¤–ã€‚

---

### Promise.prototype.then()

**Promise** å®ä¾‹å…·æœ‰ `then` æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ`then` æ–¹æ³•æ˜¯å®šä¹‰åœ¨åŸå‹å¯¹è±¡ `Promise.prototype` ä¸Šçš„ã€‚å®ƒçš„ä½œç”¨æ˜¯ä¸º **Promise** å®ä¾‹æ·»åŠ çŠ¶æ€æ”¹å˜æ—¶çš„å›è°ƒå‡½æ•°ã€‚

`then` æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ `resolved` çŠ¶æ€çš„å›è°ƒå‡½æ•°ï¼Œç¬¬äºŒä¸ªå‚æ•°ï¼ˆå¯é€‰ï¼‰æ˜¯ `rejected` çŠ¶æ€çš„å›è°ƒå‡½æ•°ã€‚

`then` æ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ªæ–°çš„ **Promise** å®ä¾‹ï¼ˆ æ³¨æ„ï¼Œä¸æ˜¯åŸæ¥é‚£ä¸ª **Promise** å®ä¾‹ ï¼‰ã€‚å› æ­¤å¯ä»¥é‡‡ç”¨é“¾å¼å†™æ³•ï¼Œå³ `then` æ–¹æ³•åé¢å†è°ƒç”¨å¦ä¸€ä¸ª `then` æ–¹æ³•ã€‚

#### then çš„è¿”å›å€¼ï¼š

- å¦‚æœ `then` ä¸­çš„å›è°ƒå‡½æ•°è¿”å›ä¸€ä¸ªå€¼ï¼Œé‚£ä¹ˆ `then` è¿”å›çš„ **Promise** å°†ä¼šæˆä¸ºæ¥å—çŠ¶æ€ï¼Œå¹¶ä¸”å°†è¿”å›çš„å€¼ä½œä¸ºæ¥å—çŠ¶æ€çš„å›è°ƒå‡½æ•°çš„å‚æ•°å€¼ã€‚
- å¦‚æœ `then` ä¸­çš„å›è°ƒå‡½æ•°æŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œé‚£ä¹ˆ `then` è¿”å›çš„ **Promise** å°†ä¼šæˆä¸ºæ‹’ç»çŠ¶æ€ï¼Œå¹¶ä¸”å°†æŠ›å‡ºçš„é”™è¯¯ä½œä¸ºæ‹’ç»çŠ¶æ€çš„å›è°ƒå‡½æ•°çš„å‚æ•°å€¼ã€‚
- å¦‚æœ `then` ä¸­çš„å›è°ƒå‡½æ•°è¿”å›ä¸€ä¸ªå·²ç»æ˜¯æ¥å—çŠ¶æ€çš„ **Promise** ï¼Œé‚£ä¹ˆ `then` è¿”å›çš„ **Promise** ä¹Ÿä¼šæˆä¸ºæ¥å—çŠ¶æ€ï¼Œå¹¶ä¸”å°†é‚£ä¸ª **Promise** çš„æ¥å—çŠ¶æ€çš„å›è°ƒå‡½æ•°çš„å‚æ•°å€¼ä½œä¸ºè¯¥è¢«è¿”å›çš„ **Promise** çš„æ¥å—çŠ¶æ€å›è°ƒå‡½æ•°çš„å‚æ•°å€¼ã€‚
- å¦‚æœ `then` ä¸­çš„å›è°ƒå‡½æ•°è¿”å›ä¸€ä¸ªå·²ç»æ˜¯æ‹’ç»çŠ¶æ€çš„ **Promise** ï¼Œé‚£ä¹ˆ `then` è¿”å›çš„ **Promise** ä¹Ÿä¼šæˆä¸ºæ‹’ç»çŠ¶æ€ï¼Œå¹¶ä¸”å°†é‚£ä¸ª **Promise** çš„æ‹’ç»çŠ¶æ€çš„å›è°ƒå‡½æ•°çš„å‚æ•°å€¼ä½œä¸ºè¯¥è¢«è¿”å›çš„ **Promise** çš„æ‹’ç»çŠ¶æ€å›è°ƒå‡½æ•°çš„å‚æ•°å€¼ã€‚
- å¦‚æœ `then` ä¸­çš„å›è°ƒå‡½æ•°è¿”å›ä¸€ä¸ªæœªå®šçŠ¶æ€ï¼ˆpendingï¼‰çš„ **Promise** ï¼Œé‚£ä¹ˆ `then` è¿”å› **Promise** çš„çŠ¶æ€ä¹Ÿæ˜¯æœªå®šçš„ï¼Œå¹¶ä¸”å®ƒçš„ç»ˆæ€ä¸é‚£ä¸ª **Promise** çš„ç»ˆæ€ç›¸åŒï¼›åŒæ—¶ï¼Œå®ƒå˜ä¸ºç»ˆæ€æ—¶è°ƒç”¨çš„å›è°ƒå‡½æ•°å‚æ•°ä¸é‚£ä¸ª **Promise** å˜ä¸ºç»ˆæ€æ—¶çš„å›è°ƒå‡½æ•°çš„å‚æ•°æ˜¯ç›¸åŒçš„ã€‚

ä¸¾ä¸€ä¸ªå®˜ç½‘ [Promise.prototype.then() - JavaScript | MDN](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/then) çš„å®ä¾‹ï¼š

```javascript
Promise.resolve("foo")
  // 1. æ¥æ”¶ "foo" å¹¶ä¸ "bar" æ‹¼æ¥ï¼Œå¹¶å°†å…¶ç»“æœåšä¸ºä¸‹ä¸€ä¸ªresolveè¿”å›ã€‚
  .then(function(string) {
    return new Promise(function(resolve, reject) {
      setTimeout(function() {
        string += 'bar'
        resolve(string)
      }, 1)
    })
  })
  // 2. æ¥æ”¶ "foobar", æ”¾å…¥ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ä¸­å¤„ç†è¯¥å­—ç¬¦ä¸²
  // å¹¶å°†å…¶æ‰“å°åˆ°æ§åˆ¶å°ä¸­, ä½†æ˜¯ä¸å°†å¤„ç†åçš„å­—ç¬¦ä¸²è¿”å›åˆ°ä¸‹ä¸€ä¸ªã€‚
  .then(function(string) {
    setTimeout(function() {
      string += 'baz'
      console.log(string)
    }, 1)
    return string
  })
  // 3. æ‰“å°æœ¬èŠ‚ä¸­ä»£ç å°†å¦‚ä½•è¿è¡Œçš„å¸®åŠ©æ¶ˆæ¯ï¼Œ
  // å­—ç¬¦ä¸²å®é™…ä¸Šæ˜¯ç”±ä¸Šä¸€ä¸ªå›è°ƒå‡½æ•°ä¹‹å‰çš„é‚£å—å¼‚æ­¥ä»£ç å¤„ç†çš„ã€‚
  .then(function(string) {
    console.log("end")

    // æ³¨æ„ `string` è¿™æ—¶ä¸ä¼šå­˜åœ¨ 'baz'ã€‚
    // å› ä¸ºè¿™æ˜¯å‘ç”Ÿåœ¨æˆ‘ä»¬é€šè¿‡ setTimeout æ¨¡æ‹Ÿçš„å¼‚æ­¥å‡½æ•°ä¸­ã€‚
    console.log(string)
})
// end
// foobar
// foobarbaz
```

ä¸ªäººåˆ†æï¼š

1. ç¬¬ä¸€æ­¥ï¼Œ**Promise** å¯¹è±¡è°ƒç”¨æˆåŠŸçš„å›è°ƒå‡½æ•°ï¼Œå¹¶ä¼ å…¥å‚æ•° `foo`
2. ç”±äºä¸Šä¸€ä¸ª **Promise** å¯¹è±¡è¿”å›çš„æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥ç¬¬ä¸€ä¸ª `then` æ¥æ”¶åˆ°çš„æ˜¯ä¸€ä¸ªã€Œæ¥å—çŠ¶æ€ã€çš„ **Promise**ï¼Œå®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆ æ¥å—çŠ¶æ€ ï¼‰çš„å›è°ƒå‡½æ•°è¢«æ‰§è¡Œï¼Œä¸”å‚æ•°ä¸ºä¸Šä¸€ä¸ª **Promise** å¯¹è±¡çš„è¿”å›å€¼ï¼š`foo`ï¼Œè¿™æ—¶å€™ `return` ä¸€ä¸ª **Promise** å¯¹è±¡ã€‚
3. ç¬¬äºŒä¸ª `then` æ¥æ”¶åˆ°çš„æ˜¯ä¸€ä¸ªã€Œæœªå®šçŠ¶æ€ã€çš„ **Promise**ï¼Œæ‰€ä»¥è¿™ä¸ª `then` çš„æœ€ç»ˆçŠ¶æ€æ˜¯ç”±æ¥å—åˆ°çš„ **Promise** çš„æœ€ç»ˆçŠ¶æ€å†³å®šçš„ã€‚
4. 1 ms åï¼Œç¬¬äºŒä¸ª `then` æ¥æ”¶åˆ°çš„ **Promise** å˜æˆæ¥å—çŠ¶æ€ï¼Œè€Œä¸”æ­¤æ—¶ `resolve` çš„å‚æ•°ä¹Ÿæ·»åŠ äº† `bar`ï¼›æ‰€ä»¥ï¼Œç¬¬äºŒä¸ª `then` æ–¹æ³•ä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆ æ¥å—çŠ¶æ€ ï¼‰çš„å›è°ƒå‡½æ•°è¢«æ‰§è¡Œï¼Œæ¥æ”¶åˆ°çš„å‚æ•°ä¸º `foobar`ï¼Œå¹¶ä¸”åˆ›å»ºäº†ä¸€ä¸ªå®šæ—¶å™¨ï¼Œä»è€Œå…ˆæ‰§è¡Œçš„ `return` è¯­å¥ï¼Œæ­¤æ—¶ `return` çš„å€¼ä¸º `foobar`ã€‚
5. ç”±äºä¸Šä¸€ä¸ª **Promise** å¯¹è±¡è¿”å›çš„æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥ç¬¬ä¸‰ä¸ª `then` æ¥æ”¶åˆ°çš„æ˜¯ä¸€ä¸ªã€Œæ¥å—çŠ¶æ€ã€çš„ **Promise**ï¼Œå®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆ æ¥å—çŠ¶æ€ ï¼‰çš„å›è°ƒå‡½æ•°è¢«æ‰§è¡Œï¼Œä¸”å‚æ•°ä¸ºä¸Šä¸€ä¸ª **Promise** å¯¹è±¡çš„è¿”å›å€¼ï¼š`foobar`ã€‚
6. æ‰€ä»¥ï¼Œå…ˆè¾“å‡ºçš„ `end`ï¼Œç„¶åè¾“å‡ºçš„ `foobar`ï¼Œæœ€åæ‰è¾“å‡ºç¬¬äºŒä¸ªå®šæ—¶å™¨ä¸­çš„å­—ç¬¦ä¸² `foobarbaz`ã€‚

---

### Promise.prototype.catch()

> è¿”å›ä¸€ä¸ªPromiseï¼Œåªå¤„ç†æ‹’ç»çš„æƒ…å†µã€‚å®ƒçš„è¡Œä¸ºä¸è°ƒç”¨ `Promise.prototype.then(undefined, onRejected)` ç›¸åŒã€‚

`promise` æŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œå°±è¢« `catch` æ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°æ•è·ã€‚ä¸‹é¢ä¸¤ç§å†™æ³•æ˜¯ç­‰ä»·çš„ï¼š

```javascript
// å†™æ³•ä¸€
const promise = new Promise(function(resolve, reject) {
  try {
    throw new Error('test')
  } catch(e) {
    reject(e)
  }
})
promise.catch(function(error) {
  console.log(error)
})

// å†™æ³•äºŒ
const promise = new Promise(function(resolve, reject) {
  reject(new Error('test'))
})
promise.catch(function(error) {
  console.log(error)
})
```

**Promise** å¯¹è±¡çš„é”™è¯¯å…·æœ‰ã€Œå†’æ³¡ã€æ€§è´¨ï¼Œä¼šä¸€ç›´å‘åä¼ é€’ï¼Œç›´åˆ°è¢«æ•è·ä¸ºæ­¢ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé”™è¯¯æ€»æ˜¯ä¼šè¢«ä¸‹ä¸€ä¸ª `catch` è¯­å¥æ•è·ã€‚

```javascript
promise.then(function(value) {
  return value
}).then(function(value) {
  // some code
}).catch(function(error) {
  // å¤„ç†å‰é¢ä¸‰ä¸ª Promise äº§ç”Ÿçš„é”™è¯¯
});
```

æ‰€ä»¥ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œä¸è¦åœ¨ `then` æ–¹æ³•é‡Œé¢å®šä¹‰ Reject çŠ¶æ€çš„å›è°ƒå‡½æ•°ï¼ˆ å³ `then` çš„ç¬¬äºŒä¸ªå‚æ•° ï¼‰ï¼Œæ€»æ˜¯ä½¿ç”¨ `catch` æ–¹æ³•ä¼šæ›´å¥½ä¸€äº›ã€‚

è·Ÿä¼ ç»Ÿçš„ `try/catch` ä»£ç å—ä¸åŒçš„æ˜¯ï¼Œå¦‚æœæ²¡æœ‰ä½¿ç”¨ `catch` æ–¹æ³•æŒ‡å®šé”™è¯¯å¤„ç†çš„å›è°ƒå‡½æ•°ï¼Œ**Promise** å¯¹è±¡æŠ›å‡ºçš„é”™è¯¯**ä¸ä¼šä¼ é€’åˆ°å¤–å±‚ä»£ç **ï¼Œå³ä¸ä¼šæœ‰ä»»ä½•ååº”ã€‚è¿™å°±æ˜¯è¯´ï¼Œ**Promise** å†…éƒ¨çš„é”™è¯¯ä¸ä¼šå½±å“åˆ° **Promise** å¤–éƒ¨çš„ä»£ç ï¼Œé€šä¿—çš„è¯´æ³•å°±æ˜¯ã€Œ**Promise** ä¼šåƒæ‰é”™è¯¯ã€ã€‚ä¸¾ä¸ªä¾‹å­ï¼š

```javascript
const someAsyncThing = function() {
  return new Promise(function(resolve, reject) {
    // ä¸‹é¢ä¸€è¡Œä¼šæŠ¥é”™ï¼Œå› ä¸ºxæ²¡æœ‰å£°æ˜
    resolve(x + 2);
  });
};

someAsyncThing().then(function() {
  console.log('everything is great');
});

setTimeout(() => { console.log(123) }, 2000);
// Uncaught (in promise) ReferenceError: x is not defined
// 123
```

ä¸Šé¢ä»£ç ä¸­ï¼Œ`someAsyncThing` å‡½æ•°äº§ç”Ÿçš„ **Promise** å¯¹è±¡ï¼Œå†…éƒ¨æœ‰è¯­æ³•é”™è¯¯ã€‚æµè§ˆå™¨è¿è¡Œåˆ°è¿™ä¸€è¡Œï¼Œä¼šæ‰“å°å‡ºé”™è¯¯æç¤º `ReferenceError: x is not defined`ï¼Œä½†æ˜¯**ä¸ä¼šé€€å‡ºè¿›ç¨‹ã€ç»ˆæ­¢è„šæœ¬æ‰§è¡Œ**ï¼Œ2 ç§’ä¹‹åè¿˜æ˜¯ä¼šè¾“å‡º `123`ã€‚

---

### Promise.all()

